#!/bin/env python

# Import modules
import unittest
from xdd.transfermanager import TransferManager 

# Standard testing strategy: try to check each side of each branch statement
# for correctness

# Test createFlows method of TransferManager
class TransferManagerCreateFlowsTestCase(unittest.TestCase):
    """Test createFlows method of TransferManager"""

    def test_empty(self):
        """Test calling createFlows without adequate data"""
        tm = TransferManager()
        try:
            rc = tm.createFlows()
            self.assertEqual(0, 1)
        except:
            self.assertEqual(1, 1)

    def test_local_mem_to_mem(self):
        """Test a local mem to local mem transfer"""
        tm = TransferManager()
        tm.setXddPath('bin')
        tm.setRequestSize(1024)
        tm.setTransferSize(1024*1024*1024*20)
        tm.setSourceTarget("/dev/zero")
        tm.setSinkTarget("/dev/null")
        tm.addSource("localhost", 1)
        tm.addSink("localhost", 1)
        rc = tm.createFlows()
        self.assertEqual(0, rc)
        rc = tm.startFlows()
        self.assertEqual(0, rc)
        rc = tm.monitorFlows(1)
        self.assertEqual(0, rc)
        rc = tm.cleanupFlows()
        self.assertEqual(0, rc)

    def test_local_mem_to_remote_mem(self):
        """Test a local mem to remote mem transfer"""
        tm = TransferManager()
        tm.setSourceXddPath('bin')
        tm.setRequestSize(1024)
        tm.setTransferSize(1024*1024*1024*20)
        tm.setSourceTarget("/dev/zero")
        tm.setSinkTarget("/dev/null")
        tm.addSource("localhost", 1)
        tm.addSink("127.0.0.1", 1)
        rc = tm.createFlows()
        self.assertEqual(0, rc)
        rc = tm.startFlows()
        self.assertEqual(0, rc)
        rc = tm.monitorFlows(1)
        self.assertEqual(0, rc)
        rc = tm.cleanupFlows()
        self.assertEqual(0, rc)

    def test_remote_mem_to_local_mem(self):
        """Test a local mem to remote mem transfer"""
        tm = TransferManager()
        tm.setSinkXddPath('bin')
        tm.setRequestSize(1024)
        tm.setTransferSize(1024*1024*1024*20)
        tm.setSourceTarget("/dev/zero")
        tm.setSinkTarget("/dev/null")
        tm.addSource("127.0.0.1", 1)
        tm.addSink("localhost", 1)
        rc = tm.createFlows()
        self.assertEqual(0, rc)
        rc = tm.startFlows()
        self.assertEqual(0, rc)
        rc = tm.monitorFlows(1)
        self.assertEqual(0, rc)
        rc = tm.cleanupFlows()
        self.assertEqual(0, rc)

    def test_remote_mem_to_remote_mem(self):
        """Test a remote mem to remote mem transfer"""
        # Pull the hostname
        import subprocess
        p = subprocess.Popen(['hostname'], stdout=subprocess.PIPE)
        (host, _) = p.communicate()
        self.assertNotEqual(0, len(host))

        # Test using 127.0.0.1 and hostname
        tm = TransferManager()
        tm.setXddPath('')
        tm.setRequestSize(1024)
        tm.setTransferSize(1024*1024*1024*80)
        tm.setSourceTarget("/dev/zero")
        tm.setSinkTarget("/dev/null")
        tm.addSource("127.0.0.1", 1, ifs = [host])
        tm.addSink(host, 1)
        rc = tm.createFlows()
        self.assertEqual(0, rc)
        rc = tm.startFlows()
        self.assertEqual(0, rc)
        rc = tm.monitorFlows(1)
        self.assertEqual(0, rc)
        rc = tm.cleanupFlows()
        self.assertEqual(0, rc)

# Test startFlows method of TransferManager
class TransferManagerStartFlowsTestCase(unittest.TestCase):
    """Test startFlows method of TransferManager"""

    def test_single_file(self):
        tm = TransferManager()
        tm.setXddPath('bin')
        tm.setRequestSize(1024)
        tm.setTransferSize(1024*1024*1024*20)
        tm.setSourceTarget("/dev/zero")
        tm.setSinkTarget("/dev/null")
        tm.addSource("localhost", 1)
        tm.addSink("localhost", 1)
        rc = tm.createFlows()
        self.assertEqual(0, rc)
        rc = tm.startFlows()
        self.assertEqual(0, rc)
        rc = tm.monitorFlows(1)
        self.assertEqual(0, rc)
        rc = tm.cleanupFlows()
        self.assertEqual(0, rc)
        pass

    def test_single_file_with_restart(self):
        tm = TransferManager()
        tm.setXddPath('bin')
        tm.setRequestSize(1024)
        tm.setTransferSize(1024*1024*1024*20)
        tm.setSourceTarget("/dev/zero")
        tm.setSinkTarget("/dev/null")
        tm.addSource("localhost", 1)
        tm.addSink("localhost", 1)
        rc = tm.createFlows()
        self.assertEqual(0, rc)
        rc = tm.startFlows()
        self.assertEqual(0, rc)
        rc = tm.monitorFlows(1)
        self.assertEqual(0, rc)
        rc = tm.cleanupFlows()
        self.assertEqual(0, rc)
        pass

    def test_directory(self):
        pass

if __name__ == '__main__':
    unittest.main()

